import{G as X,O as k,o as B,p as Z,M as ee,h as te,e as ne,B as se,a as oe,I as ae,q as ie,r as re,t as le}from"./teleport-77ede96c.js";import{s as de}from"./setup-746c8827.js";const d={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function $(n){const e=await fetch(n);if(e.ok)return e.json();throw new Error(e.statusText)}async function he(n){if(!n)throw new Error("No basePath supplied");return await $(`${n}/profilesList.json`)}async function ue(n,e,t=null,o=!0){if(!n)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const a=await he(e);let s;if(n.profiles.some(r=>{const h=a[r];return h&&(s={profileId:r,profilePath:`${e}/${h.path}`,deprecated:!!h.deprecated}),!!s}),!s){if(!t)throw new Error("No matching profile name found");const r=a[t];if(!r)throw new Error(`No matching profile name found and default profile "${t}" missing.`);s={profileId:t,profilePath:`${e}/${r.path}`,deprecated:!!r.deprecated}}const i=await $(s.profilePath);let l;if(o){let r;if(n.handedness==="any"?r=i.layouts[Object.keys(i.layouts)[0]]:r=i.layouts[n.handedness],!r)throw new Error(`No matching handedness, ${n.handedness}, in profile ${s.profileId}`);r.assetPath&&(l=s.profilePath.replace("profile.json",r.assetPath))}return{profile:i,assetPath:l}}const ce={xAxis:0,yAxis:0,button:0,state:d.ComponentState.DEFAULT};function pe(n=0,e=0){let t=n,o=e;if(Math.sqrt(n*n+e*e)>1){const i=Math.atan2(e,n);t=Math.cos(i),o=Math.sin(i)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:o*.5+.5}}class me{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===d.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(ce)}updateFromComponent({xAxis:e,yAxis:t,button:o,state:a}){const{normalizedXAxis:s,normalizedYAxis:i}=pe(e,t);switch(this.componentProperty){case d.ComponentProperty.X_AXIS:this.value=this.states.includes(a)?s:.5;break;case d.ComponentProperty.Y_AXIS:this.value=this.states.includes(a)?i:.5;break;case d.ComponentProperty.BUTTON:this.value=this.states.includes(a)?o:0;break;case d.ComponentProperty.STATE:this.valueNodeProperty===d.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(a):this.value=this.states.includes(a)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class fe{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(o=>{const a=new me(t.visualResponses[o]);this.visualResponses[o]=a}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:d.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=d.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=d.ComponentState.PRESSED:(t.touched||this.values.button>d.ButtonTouchThreshold)&&(this.values.state=d.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===d.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>d.AxisTouchThreshold&&(this.values.state=d.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===d.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>d.AxisTouchThreshold&&(this.values.state=d.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class xe{constructor(e,t,o){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=o,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(a=>{const s=this.layoutDescription.components[a];this.components[a]=new fe(a,s)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const ge="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",ve="generic-trigger";class ye extends k{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(o=>{const{valueNode:a,minNode:s,maxNode:i,value:l,valueNodeProperty:r}=o;a&&(r===d.VisualResponseProperty.VISIBILITY?a.visible=l:r===d.VisualResponseProperty.TRANSFORM&&(a.quaternion.slerpQuaternions(s.quaternion,i.quaternion,l),a.position.lerpVectors(s.position,i.position,l)))})}))}}function be(n,e){Object.values(n.components).forEach(t=>{const{type:o,touchPointNodeName:a,visualResponses:s}=t;if(o===d.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(a),t.touchPointNode){const i=new B(.001),l=new Z({color:255}),r=new ee(i,l);t.touchPointNode.add(r)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(s).forEach(i=>{const{valueNodeName:l,minNodeName:r,maxNodeName:h,valueNodeProperty:p}=i;if(p===d.VisualResponseProperty.TRANSFORM){if(i.minNode=e.getObjectByName(r),i.maxNode=e.getObjectByName(h),!i.minNode){console.warn(`Could not find ${r} in the model`);return}if(!i.maxNode){console.warn(`Could not find ${h} in the model`);return}}i.valueNode=e.getObjectByName(l),i.valueNode||console.warn(`Could not find ${l} in the model`)})})}function L(n,e){be(n.motionController,e),n.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=n.envMap,t.material.needsUpdate=!0)}),n.add(e)}class we{constructor(e=null){this.gltfLoader=e,this.path=ge,this._assetCache={},this.gltfLoader||(this.gltfLoader=new X)}createControllerModel(e){const t=new ye;let o=null;return e.addEventListener("connected",a=>{const s=a.data;s.targetRayMode!=="tracked-pointer"||!s.gamepad||ue(s,this.path,ve).then(({profile:i,assetPath:l})=>{t.motionController=new xe(s,i,l);const r=this._assetCache[t.motionController.assetUrl];if(r)o=r.scene.clone(),L(t,o);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,h=>{this._assetCache[t.motionController.assetUrl]=h,o=h.scene.clone(),L(t,o)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(i=>{console.warn(i)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(o),o=null}),t}}let T=!1,A,S,g,v,M,N;const G=n=>{const e=new we;M=n.xr.getController(0),M.name="XR Controller Left",M.userData.index=0,N=n.xr.getController(1),N.name="XR Controller Right",N.userData.index=1,g=n.xr.getControllerGrip(0),g.name="XR Controller Grip Left",g.userData.index=0,A=e.createControllerModel(g),g.add(A),v=n.xr.getControllerGrip(1),v.name="XR Controller Grip Right",v.userData.index=1,S=e.createControllerModel(v),v.add(S),T=!0},P=n=>(T||G(n),{grip0:g,grip1:v,controller0:M,controller1:N}),Ce=n=>(T||G(n),{model0:A,model1:S}),Me=()=>{const n={};return{listeners:n,on:(a,s)=>{n[a]??(n[a]=[]),n[a].push(s)},off:(a,s)=>{const i=n[a];i!==void 0&&i.splice(i.indexOf(s),1)},fire:a=>{const s=n[a];if(s!==void 0)for(let i=0,l=s.length;i<l;i+=1)s[i]()}}},I=new te,j=new ne;class F{constructor(e,t,o,a,s){this.controller=t,this.handModel=e,this.envMap=null;let i;!s||!s.primitive||s.primitive==="sphere"?i=new B(1,10,10):s.primitive==="box"&&(i=new se(1,1,1));const l=new oe;this.handMesh=new ae(i,l,30),this.handMesh.frustumCulled=!1,this.handMesh.instanceMatrix.setUsage(ie),this.handMesh.castShadow=!0,this.handMesh.receiveShadow=!0,this.handModel.add(this.handMesh),this.joints=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]}updateMesh(){const t=this.controller.joints;let o=0;for(let a=0;a<this.joints.length;a++){const s=t[this.joints[a]];s.visible&&(j.setScalar(s.jointRadius||.008),I.compose(s.position,s.quaternion,j),this.handMesh.setMatrixAt(a,I),o++)}this.handMesh.count=o,this.handMesh.instanceMatrix.needsUpdate=!0}}const Ne="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class Ee{constructor(e,t,o,a,s=null){this.controller=t,this.handModel=e,this.bones=[],s===null&&(s=new X,s.setPath(o||Ne)),s.load(`${a}.glb`,i=>{const l=i.scene.children[0];this.handModel.add(l);const r=l.getObjectByProperty("type","SkinnedMesh");r.frustumCulled=!1,r.castShadow=!0,r.receiveShadow=!0,["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(p=>{const w=l.getObjectByName(p);w!==void 0?w.jointName=p:console.warn(`Couldn't find ${p} in ${a} hand mesh`),this.bones.push(w)})})}updateMesh(){const e=this.controller.joints;for(let t=0;t<this.bones.length;t++){const o=this.bones[t];if(o){const a=e[o.jointName];if(a.visible){const s=a.position;o.position.copy(s),o.quaternion.copy(a.quaternion)}}}}}class Ae extends k{constructor(e){super(),this.controller=e,this.motionController=null,this.envMap=null,this.mesh=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}}class Se{constructor(){this.path=null}setPath(e){return this.path=e,this}createHandModel(e,t){const o=new Ae(e);return e.addEventListener("connected",a=>{const s=a.data;s.hand&&!o.motionController&&(o.xrInputSource=s,t===void 0||t==="spheres"?o.motionController=new F(o,e,this.path,s.handedness,{primitive:"sphere"}):t==="boxes"?o.motionController=new F(o,e,this.path,s.handedness,{primitive:"box"}):t==="mesh"&&(o.motionController=new Ee(o,e,this.path,s.handedness))),e.visible=!0}),e.addEventListener("disconnected",()=>{e.visible=!1}),o}}let D=!1,f,b;const Te=n=>{const e=new Se;f=n.xr.getHand(0),f.name="XR Hand Left",f.userData.index=0;const t=e.createHandModel(f,"mesh");t.name="XR Hand Model Left",f.add(t),b=n.xr.getHand(1),b.name="XR Hand Right",f.userData.index=1;const o=e.createHandModel(b,"mesh");o.name="XR Hand Model Right",b.add(o),D=!0},V=n=>(D||Te(n),{hand0:f,hand1:b}),E=Me();let R=!1,O=!1,q=!1,x,u,y,z,c;const Y={allowed:"Enter VR",not_allowed:"VR is not allowed",not_secure:"VR requires HTTPS",not_supported:"VR not supported"},Pe=(n,e,t)=>{u=n,y=e,z=t,u.xr.enabled=!0},W=async()=>{if(navigator.xr===void 0)return"not_supported";if(!window.isSecureContext)return"not_secure";try{return await navigator.xr.isSessionSupported("immersive-vr")?"allowed":"not_supported"}catch{return"not_allowed"}},Re=()=>E.fire("end"),Oe=()=>E.fire("exit"),J=async()=>{if(navigator.xr===void 0)throw new Error("navigator.xr is undefined!");x=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]}),x.addEventListener("end",Re),x.addEventListener("exit",Oe),await u.xr.setSession(x),R=!0,E.fire("enter")},Le=()=>{R=!1,x==null||x.end()},Ie=async()=>{const n=await W(),e=document.createElement("button");return e.textContent=Y[n],n==="allowed"&&e.addEventListener("click",J),e},Q=n=>{O=n;const{grip0:e,grip1:t,controller0:o,controller1:a}=P(u);n?y.add(e,t,o,a):y.remove(e,t,o,a)},je=n=>{q=n;const{hand0:e,hand1:t}=V(u);n?y.add(e,t):y.remove(e,t)},Fe=(...n)=>{if(c===void 0){const{controller0:e,controller1:t}=P(u);c=re(u,y,z,[e,t])}O||Q(!0),c.enable(...n)},He=()=>{c==null||c.disable()},Ue=n=>{c==null||c.update(n)},m={get entered(){return R},get handsEnabled(){return q},get controllersEnabled(){return O},supportStateMessages:Y,setup:Pe,createButton:Ie,requestSessionSupport:W,requestSession:J,endSession:Le,enableTeleport:Fe,disableTeleport:He,getControllers:()=>P(u),getControllerModels:()=>Ce(u),getHands:()=>V(u),toggleControllers:Q,toggleHands:je,update:Ue,...E},_e=`import { three, xr } from 'trzy'

const { renderer, scene, camera, xr } = three()

xr.setup(renderer, scene, camera.current)

const button = await xr.createButton()
container.append(button)

xr.enableTeleport(floor)
`,$e={title:"XR",parameters:{docs:{description:{component:""},source:{code:_e}}}},Xe=()=>{const n=document.createElement("div");n.style.cssText="width:100%;height:420px;";const{canvas:e,camera:t,scene:o,renderer:a,update:s}=le({parameters:{antialias:!0}});return n.append(e),de({controls:!1}).then(({floor:i})=>{var h;m.setup(a,o,t.current);const{model0:l,model1:r}=m.getControllerModels();l.castShadow=!0,l.receiveShadow=!0,r.castShadow=!0,r.receiveShadow=!0,(h=o.getObjectByName("Strawberry"))==null||h.position.set(0,1,0),m.createButton().then(p=>{p.style.cssText=`
        position: absolute;
        bottom: 15px;
        left: 15px;
        z-index: 100;
      `,n.append(p),m.on("enter",()=>{m.toggleControllers(!0),m.toggleHands(!0),m.enableTeleport(i)}),s((w,K)=>m.update(K))})}),n},C={render:Xe};var H,U,_;C.parameters={...C.parameters,docs:{...(H=C.parameters)==null?void 0:H.docs,source:{originalSource:`{
  render
}`,...(_=(U=C.parameters)==null?void 0:U.docs)==null?void 0:_.source}}};const Ge=["Primary"];export{C as Primary,Ge as __namedExportsOrder,$e as default};
//# sourceMappingURL=index.stories-0f6a39b8.js.map
