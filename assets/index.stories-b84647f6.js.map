{"version":3,"file":"index.stories-b84647f6.js","sources":["../../src/components/xr/index.ts","../../src/stories/xr/code.js?raw"],"sourcesContent":["import type * as THREE from 'three'\nimport { buildControllers } from './controller'\nimport { createTeleport } from './teleport'\n\nconst supportStates = {\n  ALLOWED: 0,\n  NOT_ALLOWED: 1,\n  NOT_SECURE: 2,\n  NOT_SUPPORTED: 3,\n} as const\n\ntype SupportValues = typeof supportStates[keyof typeof supportStates]\n\nconst supportStateMessages = {\n  0: 'Enter VR',\n  1: 'VR is not allowed',\n  2: 'VR requires HTTPS',\n  3: 'VR not supported',\n} as const\n\nexport const xr = (renderer: THREE.WebGLRenderer, scene: THREE.Scene, camera: THREE.Camera) => {\n  if (navigator.xr === undefined || (/WebXRViewer\\//ui).test(navigator.userAgent)) {\n    // Do nothing\n  } else {\n    navigator.xr.addEventListener('sessiongranted', () => {\n      state.sessionGranted = true\n    })\n  }\n\n  let session: XRSession | undefined\n\n  const state = {\n    sessionGranted: false,\n  }\n\n  const teleport = createTeleport(renderer, scene, camera)\n\n  const listeners: Record<string, (() => void)[]> = {}\n\n  const on = (event: string, fn: () => void) => {\n    listeners[event] ??= []\n    listeners[event]!.push(fn)\n  }\n\n  const fire = (event: string) => {\n    const fns = listeners[event]\n\n    if (fns === undefined) return\n\n    for (let i = 0, l = fns.length; i < l; i += 1) {\n      fns[i]!()\n    }\n  }\n\n  const requestSessionSupport = async (): Promise<SupportValues> => {\n    if (navigator.xr === undefined) {\n      return supportStates.NOT_SUPPORTED\n    }\n\n    if (!window.isSecureContext) {\n      return supportStates.NOT_SECURE\n    }\n\n    try {\n      const supported = await navigator.xr.isSessionSupported('immersive-vr')\n      return supported ? supportStates.ALLOWED : supportStates.NOT_SUPPORTED\n    } catch {\n      return supportStates.NOT_ALLOWED\n    }\n  }\n\n  const requestSession = async () => {\n    if (navigator.xr === undefined) {\n      throw new Error('navigator.xr is undefined!')\n    }\n\n    session = await navigator.xr.requestSession('immersive-vr', {\n      optionalFeatures: [\n        'local-floor',\n        'bounded-floor',\n        'hand-tracking',\n        'layers',\n      ],\n    })\n\n    session.addEventListener('end', () => fire('end'))\n    session.addEventListener('exit', () => fire('exit'))\n\n    await renderer.xr.setSession(session)\n\n    fire('enter')\n  }\n\n  const endSession = (): void => {\n    if (session === undefined) {\n      throw new Error('Tried to end undefined session!')\n    }\n\n    session.end()\n  }\n\n  const showControllers = () => {\n    buildControllers(renderer, scene)\n    return self\n  }\n\n  const enableTeleport = (...navmesh: THREE.Object3D[]) => {\n    teleport.enable(...navmesh)\n    return self\n  }\n\n  const disableTeleport = () => {\n    teleport.disable()\n  }\n\n  const createButton = async () => {\n    const xrSupport = await requestSessionSupport()\n    const button = document.createElement('button')\n    button.textContent = supportStateMessages[xrSupport]\n  \n    if (xrSupport === supportStates.ALLOWED) {\n      button.addEventListener('click', requestSession)\n    }\n  \n    return button\n  }\n\n  const update = (delta: number) => {\n    teleport.update(delta)\n  }\n\n  const self = {\n    state,\n    supportStates,\n    supportStateMessages,\n    createButton,\n    requestSessionSupport,\n    requestSession,\n    endSession,\n    showControllers,\n    enableTeleport,\n    disableTeleport,\n    on,\n    update,\n  }  \n\n  return self\n}\n","export default \"import { three } from 'trzy'\\nimport WebGPU from 'three/examples/jsm/capabilities/WebGPU'\\nimport WebGPURenderer from 'three/examples/jsm/renderers/webgpu/WebGPURenderer'\\n\\nconst renderer = WebGPU.isAvailable() ? new WebGPURenderer() : undefined\\nconst { update } = three({ renderer })\\n\\nupdate(() => {\\n  \\n})\\n\""],"names":["supportStates","supportStateMessages","xr","renderer","scene","camera","state","session","teleport","createTeleport","listeners","on","event","fn","fire","fns","i","l","requestSessionSupport","requestSession","self","xrSupport","button","buildControllers","navmesh","delta","code"],"mappings":"yGAIA,MAAMA,EAAgB,CACpB,QAAS,EACT,YAAa,EACb,WAAY,EACZ,cAAe,CACjB,EAIMC,EAAuB,CAC3B,EAAG,WACH,EAAG,oBACH,EAAG,oBACH,EAAG,kBACL,EAEaC,EAAK,CAACC,EAA+BC,EAAoBC,IAAyB,CACzF,UAAU,KAAO,QAAc,kBAAmB,KAAK,UAAU,SAAS,GAGlE,UAAA,GAAG,iBAAiB,iBAAkB,IAAM,CACpDC,EAAM,eAAiB,EAAA,CACxB,EAGC,IAAAC,EAEJ,MAAMD,EAAQ,CACZ,eAAgB,EAAA,EAGZE,EAAWC,EAAeN,EAAUC,EAAOC,CAAM,EAEjDK,EAA4C,CAAA,EAE5CC,EAAK,CAACC,EAAeC,IAAmB,CAClCH,EAAAE,KAAAF,EAAAE,GAAW,IACXF,EAAAE,CAAK,EAAG,KAAKC,CAAE,CAAA,EAGrBC,EAAQF,GAAkB,CACxB,MAAAG,EAAML,EAAUE,CAAK,EAE3B,GAAIG,IAAQ,OAEH,QAAAC,EAAI,EAAGC,EAAIF,EAAI,OAAQC,EAAIC,EAAGD,GAAK,EAC1CD,EAAIC,CAAC,GACP,EAGIE,EAAwB,SAAoC,CAC5D,GAAA,UAAU,KAAO,OACnB,OAAOlB,EAAc,cAGnB,GAAA,CAAC,OAAO,gBACV,OAAOA,EAAc,WAGnB,GAAA,CAEK,OADW,MAAM,UAAU,GAAG,mBAAmB,cAAc,EACnDA,EAAc,QAAUA,EAAc,aAAA,MACzD,CACA,OAAOA,EAAc,WACvB,CAAA,EAGImB,EAAiB,SAAY,CAC7B,GAAA,UAAU,KAAO,OACb,MAAA,IAAI,MAAM,4BAA4B,EAG9CZ,EAAU,MAAM,UAAU,GAAG,eAAe,eAAgB,CAC1D,iBAAkB,CAChB,cACA,gBACA,gBACA,QACF,CAAA,CACD,EAEDA,EAAQ,iBAAiB,MAAO,IAAMO,EAAK,KAAK,CAAC,EACjDP,EAAQ,iBAAiB,OAAQ,IAAMO,EAAK,MAAM,CAAC,EAE7C,MAAAX,EAAS,GAAG,WAAWI,CAAO,EAEpCO,EAAK,OAAO,CAAA,EAyCRM,EAAO,CACX,MAAAd,EACA,cAAAN,EACA,qBAAAC,EACA,aApBmB,SAAY,CACzB,MAAAoB,EAAY,MAAMH,IAClBI,EAAS,SAAS,cAAc,QAAQ,EACvC,OAAAA,EAAA,YAAcrB,EAAqBoB,CAAS,EAE/CA,IAAcrB,EAAc,SACvBsB,EAAA,iBAAiB,QAASH,CAAc,EAG1CG,CAAA,EAYP,sBAAAJ,EACA,eAAAC,EACA,WA7CiB,IAAY,CAC7B,GAAIZ,IAAY,OACR,MAAA,IAAI,MAAM,iCAAiC,EAGnDA,EAAQ,IAAI,CAAA,EAyCZ,gBAtCsB,KACtBgB,EAAiBpB,EAAUC,CAAK,EACzBgB,GAqCP,eAlCqB,IAAII,KAChBhB,EAAA,OAAO,GAAGgB,CAAO,EACnBJ,GAiCP,gBA9BsB,IAAM,CAC5BZ,EAAS,QAAQ,CAAA,EA8BjB,GAAAG,EACA,OAhBcc,GAAkB,CAChCjB,EAAS,OAAOiB,CAAK,CAAA,CAerB,EAGK,OAAAL,CACT,ECnJeM,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;"}