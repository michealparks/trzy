{"version":3,"file":"index.stories-6091b5ff.js","sources":["../../src/components/xr/index.ts","../../src/components/xr/code.js?raw"],"sourcesContent":["import type * as THREE from 'three'\nimport { buildControllers } from './controller'\nimport { createTeleport } from './teleport'\n\nconst supportStateMessages = {\n  'allowed': 'Enter VR',\n  'not_allowed': 'VR is not allowed',\n  'not_secure': 'VR requires HTTPS',\n  'not_supported': 'VR not supported',\n} as const\n\nexport const xr = (renderer: THREE.WebGLRenderer, scene: THREE.Scene, camera: THREE.Camera) => {\n  if (navigator.xr === undefined || (/WebXRViewer\\//ui).test(navigator.userAgent)) {\n    // Do nothing\n  } else {\n    navigator.xr.addEventListener('sessiongranted', () => {\n      state.sessionGranted = true\n    })\n  }\n\n  let session: XRSession | undefined\n\n  const state = {\n    sessionGranted: false,\n  }\n\n  const teleport = createTeleport(renderer, scene, camera)\n\n  const listeners: Record<string, (() => void)[]> = {}\n\n  const on = (event: string, fn: () => void) => {\n    listeners[event] ??= []\n    listeners[event]!.push(fn)\n  }\n\n  const fire = (event: string) => {\n    const fns = listeners[event]\n\n    if (fns === undefined) return\n\n    for (let i = 0, l = fns.length; i < l; i += 1) {\n      fns[i]!()\n    }\n  }\n\n  const requestSessionSupport = async (): Promise<'allowed' | 'not_allowed' | 'not_secure' | 'not_supported'> => {\n    if (navigator.xr === undefined) {\n      return 'not_supported'\n    }\n\n    if (!window.isSecureContext) {\n      return 'not_secure'\n    }\n\n    try {\n      const supported = await navigator.xr.isSessionSupported('immersive-vr')\n      return supported ? 'allowed' : 'not_supported'\n    } catch {\n      return 'not_allowed'\n    }\n  }\n\n  const requestSession = async () => {\n    if (navigator.xr === undefined) {\n      throw new Error('navigator.xr is undefined!')\n    }\n\n    session = await navigator.xr.requestSession('immersive-vr', {\n      optionalFeatures: [\n        'local-floor',\n        'bounded-floor',\n        'hand-tracking',\n        'layers',\n      ],\n    })\n\n    session.addEventListener('end', () => fire('end'))\n    session.addEventListener('exit', () => fire('exit'))\n\n    await renderer.xr.setSession(session)\n\n    fire('enter')\n  }\n\n  const endSession = (): void => {\n    if (session === undefined) {\n      throw new Error('Tried to end undefined session!')\n    }\n\n    session.end()\n  }\n\n  const addControllers = () => {\n    buildControllers(renderer, scene)\n    return self\n  }\n\n  const enableTeleport = (...navMeshes: THREE.Object3D[]) => {\n    teleport.enable(...navMeshes)\n    return self\n  }\n\n  const disableTeleport = () => {\n    teleport.disable()\n  }\n\n  const createButton = async () => {\n    const xrSupport = await requestSessionSupport()\n    const button = document.createElement('button')\n    button.textContent = supportStateMessages[xrSupport]\n  \n    if (xrSupport === 'allowed') {\n      button.addEventListener('click', requestSession)\n    }\n  \n    return button\n  }\n\n  const update = (delta: number) => {\n    teleport.update(delta)\n  }\n\n  const self = {\n    state,\n    supportStateMessages,\n    createButton,\n    requestSessionSupport,\n    requestSession,\n    endSession,\n    addControllers,\n    enableTeleport,\n    disableTeleport,\n    on,\n    update,\n  }  \n\n  return self\n}\n","export default \"import { three, xr } from '.'\\n\\nconst { renderer, scene, camera } = three()\\nconst vr = xr(renderer, scene, camera)\\n\\ndocument.body.append(await vr.createButton())\\n\\nconst support = await vr.requestSessionSupport()\\n\""],"names":["supportStateMessages","xr","renderer","scene","camera","state","session","teleport","createTeleport","listeners","on","event","fn","fire","fns","i","l","requestSessionSupport","requestSession","self","xrSupport","button","buildControllers","navMeshes","delta","code"],"mappings":"sGAIA,MAAMA,EAAuB,CAC3B,QAAW,WACX,YAAe,oBACf,WAAc,oBACd,cAAiB,kBACnB,EAEaC,EAAK,CAACC,EAA+BC,EAAoBC,IAAyB,CACzF,UAAU,KAAO,QAAc,kBAAmB,KAAK,UAAU,SAAS,GAGlE,UAAA,GAAG,iBAAiB,iBAAkB,IAAM,CACpDC,EAAM,eAAiB,EAAA,CACxB,EAGC,IAAAC,EAEJ,MAAMD,EAAQ,CACZ,eAAgB,EAAA,EAGZE,EAAWC,EAAeN,EAAUC,EAAOC,CAAM,EAEjDK,EAA4C,CAAA,EAE5CC,EAAK,CAACC,EAAeC,IAAmB,CAClCH,EAAAE,KAAAF,EAAAE,GAAW,IACXF,EAAAE,CAAK,EAAG,KAAKC,CAAE,CAAA,EAGrBC,EAAQF,GAAkB,CACxB,MAAAG,EAAML,EAAUE,CAAK,EAE3B,GAAIG,IAAQ,OAEH,QAAAC,EAAI,EAAGC,EAAIF,EAAI,OAAQC,EAAIC,EAAGD,GAAK,EAC1CD,EAAIC,CAAC,GACP,EAGIE,EAAwB,SAAiF,CACzG,GAAA,UAAU,KAAO,OACZ,MAAA,gBAGL,GAAA,CAAC,OAAO,gBACH,MAAA,aAGL,GAAA,CAEF,OADkB,MAAM,UAAU,GAAG,mBAAmB,cAAc,EACnD,UAAY,eAAA,MAC/B,CACO,MAAA,aACT,CAAA,EAGIC,EAAiB,SAAY,CAC7B,GAAA,UAAU,KAAO,OACb,MAAA,IAAI,MAAM,4BAA4B,EAG9CZ,EAAU,MAAM,UAAU,GAAG,eAAe,eAAgB,CAC1D,iBAAkB,CAChB,cACA,gBACA,gBACA,QACF,CAAA,CACD,EAEDA,EAAQ,iBAAiB,MAAO,IAAMO,EAAK,KAAK,CAAC,EACjDP,EAAQ,iBAAiB,OAAQ,IAAMO,EAAK,MAAM,CAAC,EAE7C,MAAAX,EAAS,GAAG,WAAWI,CAAO,EAEpCO,EAAK,OAAO,CAAA,EAyCRM,EAAO,CACX,MAAAd,EACA,qBAAAL,EACA,aAnBmB,SAAY,CACzB,MAAAoB,EAAY,MAAMH,IAClBI,EAAS,SAAS,cAAc,QAAQ,EACvC,OAAAA,EAAA,YAAcrB,EAAqBoB,CAAS,EAE/CA,IAAc,WACTC,EAAA,iBAAiB,QAASH,CAAc,EAG1CG,CAAA,EAWP,sBAAAJ,EACA,eAAAC,EACA,WA5CiB,IAAY,CAC7B,GAAIZ,IAAY,OACR,MAAA,IAAI,MAAM,iCAAiC,EAGnDA,EAAQ,IAAI,CAAA,EAwCZ,eArCqB,KACrBgB,EAAiBpB,EAAUC,CAAK,EACzBgB,GAoCP,eAjCqB,IAAII,KAChBhB,EAAA,OAAO,GAAGgB,CAAS,EACrBJ,GAgCP,gBA7BsB,IAAM,CAC5BZ,EAAS,QAAQ,CAAA,EA6BjB,GAAAG,EACA,OAfcc,GAAkB,CAChCjB,EAAS,OAAOiB,CAAK,CAAA,CAcrB,EAGK,OAAAL,CACT,ECzIeM,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;"}