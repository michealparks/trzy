import{G as X,O as k,q as B,r as K,M as Z,i as ee,f as te,B as ne,b as se,I as oe,t as ae,v as ie,u as re,w as le,s as de,a as he}from"./setup-1360b994.js";const d={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function $(n){const e=await fetch(n);if(e.ok)return e.json();throw new Error(e.statusText)}async function ue(n){if(!n)throw new Error("No basePath supplied");return await $(`${n}/profilesList.json`)}async function ce(n,e,t=null,a=!0){if(!n)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const o=await ue(e);let s;if(n.profiles.some(r=>{const h=o[r];return h&&(s={profileId:r,profilePath:`${e}/${h.path}`,deprecated:!!h.deprecated}),!!s}),!s){if(!t)throw new Error("No matching profile name found");const r=o[t];if(!r)throw new Error(`No matching profile name found and default profile "${t}" missing.`);s={profileId:t,profilePath:`${e}/${r.path}`,deprecated:!!r.deprecated}}const i=await $(s.profilePath);let l;if(a){let r;if(n.handedness==="any"?r=i.layouts[Object.keys(i.layouts)[0]]:r=i.layouts[n.handedness],!r)throw new Error(`No matching handedness, ${n.handedness}, in profile ${s.profileId}`);r.assetPath&&(l=s.profilePath.replace("profile.json",r.assetPath))}return{profile:i,assetPath:l}}const pe={xAxis:0,yAxis:0,button:0,state:d.ComponentState.DEFAULT};function me(n=0,e=0){let t=n,a=e;if(Math.sqrt(n*n+e*e)>1){const i=Math.atan2(e,n);t=Math.cos(i),a=Math.sin(i)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:a*.5+.5}}class fe{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===d.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(pe)}updateFromComponent({xAxis:e,yAxis:t,button:a,state:o}){const{normalizedXAxis:s,normalizedYAxis:i}=me(e,t);switch(this.componentProperty){case d.ComponentProperty.X_AXIS:this.value=this.states.includes(o)?s:.5;break;case d.ComponentProperty.Y_AXIS:this.value=this.states.includes(o)?i:.5;break;case d.ComponentProperty.BUTTON:this.value=this.states.includes(o)?a:0;break;case d.ComponentProperty.STATE:this.valueNodeProperty===d.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(o):this.value=this.states.includes(o)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class xe{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(a=>{const o=new fe(t.visualResponses[a]);this.visualResponses[a]=o}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:d.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=d.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=d.ComponentState.PRESSED:(t.touched||this.values.button>d.ButtonTouchThreshold)&&(this.values.state=d.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===d.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>d.AxisTouchThreshold&&(this.values.state=d.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===d.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>d.AxisTouchThreshold&&(this.values.state=d.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class ge{constructor(e,t,a){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=a,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(o=>{const s=this.layoutDescription.components[o];this.components[o]=new xe(o,s)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const ve="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",ye="generic-trigger";class be extends k{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(a=>{const{valueNode:o,minNode:s,maxNode:i,value:l,valueNodeProperty:r}=a;o&&(r===d.VisualResponseProperty.VISIBILITY?o.visible=l:r===d.VisualResponseProperty.TRANSFORM&&(o.quaternion.slerpQuaternions(s.quaternion,i.quaternion,l),o.position.lerpVectors(s.position,i.position,l)))})}))}}function we(n,e){Object.values(n.components).forEach(t=>{const{type:a,touchPointNodeName:o,visualResponses:s}=t;if(a===d.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(o),t.touchPointNode){const i=new B(.001),l=new K({color:255}),r=new Z(i,l);t.touchPointNode.add(r)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(s).forEach(i=>{const{valueNodeName:l,minNodeName:r,maxNodeName:h,valueNodeProperty:m}=i;if(m===d.VisualResponseProperty.TRANSFORM){if(i.minNode=e.getObjectByName(r),i.maxNode=e.getObjectByName(h),!i.minNode){console.warn(`Could not find ${r} in the model`);return}if(!i.maxNode){console.warn(`Could not find ${h} in the model`);return}}i.valueNode=e.getObjectByName(l),i.valueNode||console.warn(`Could not find ${l} in the model`)})})}function I(n,e){we(n.motionController,e),n.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=n.envMap,t.material.needsUpdate=!0)}),n.add(e)}class Ce{constructor(e=null){this.gltfLoader=e,this.path=ve,this._assetCache={},this.gltfLoader||(this.gltfLoader=new X)}createControllerModel(e){const t=new be;let a=null;return e.addEventListener("connected",o=>{const s=o.data;s.targetRayMode!=="tracked-pointer"||!s.gamepad||ce(s,this.path,ye).then(({profile:i,assetPath:l})=>{t.motionController=new ge(s,i,l);const r=this._assetCache[t.motionController.assetUrl];if(r)a=r.scene.clone(),I(t,a);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,h=>{this._assetCache[t.motionController.assetUrl]=h,a=h.scene.clone(),I(t,a)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(i=>{console.warn(i)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(a),a=null}),t}}let S=!1,A,T,g,v,C,M;const G=n=>{const e=new Ce;C=n.xr.getController(0),C.name="XR Controller Left",C.userData.index=0,M=n.xr.getController(1),M.name="XR Controller Right",M.userData.index=1,g=n.xr.getControllerGrip(0),g.name="XR Controller Grip Left",g.userData.index=0,A=e.createControllerModel(g),g.add(A),v=n.xr.getControllerGrip(1),v.name="XR Controller Grip Right",v.userData.index=1,T=e.createControllerModel(v),v.add(T),S=!0},P=n=>(S||G(n),{grip0:g,grip1:v,controller0:C,controller1:M}),Me=n=>(S||G(n),{model0:A,model1:T}),Ne=()=>{const n={};return{listeners:n,on:(o,s)=>{n[o]??(n[o]=[]),n[o].push(s)},off:(o,s)=>{const i=n[o];i!==void 0&&i.splice(i.indexOf(s),1)},fire:o=>{const s=n[o];if(s!==void 0)for(let i=0,l=s.length;i<l;i+=1)s[i]()}}},L=new ee,j=new te;class F{constructor(e,t,a,o,s){this.controller=t,this.handModel=e,this.envMap=null;let i;!s||!s.primitive||s.primitive==="sphere"?i=new B(1,10,10):s.primitive==="box"&&(i=new ne(1,1,1));const l=new se;this.handMesh=new oe(i,l,30),this.handMesh.frustumCulled=!1,this.handMesh.instanceMatrix.setUsage(ae),this.handMesh.castShadow=!0,this.handMesh.receiveShadow=!0,this.handModel.add(this.handMesh),this.joints=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]}updateMesh(){const t=this.controller.joints;let a=0;for(let o=0;o<this.joints.length;o++){const s=t[this.joints[o]];s.visible&&(j.setScalar(s.jointRadius||.008),L.compose(s.position,s.quaternion,j),this.handMesh.setMatrixAt(o,L),a++)}this.handMesh.count=a,this.handMesh.instanceMatrix.needsUpdate=!0}}const Ee="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class Ae{constructor(e,t,a,o,s=null){this.controller=t,this.handModel=e,this.bones=[],s===null&&(s=new X,s.setPath(a||Ee)),s.load(`${o}.glb`,i=>{const l=i.scene.children[0];this.handModel.add(l);const r=l.getObjectByProperty("type","SkinnedMesh");r.frustumCulled=!1,r.castShadow=!0,r.receiveShadow=!0,["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(m=>{const E=l.getObjectByName(m);E!==void 0?E.jointName=m:console.warn(`Couldn't find ${m} in ${o} hand mesh`),this.bones.push(E)})})}updateMesh(){const e=this.controller.joints;for(let t=0;t<this.bones.length;t++){const a=this.bones[t];if(a){const o=e[a.jointName];if(o.visible){const s=o.position;a.position.copy(s),a.quaternion.copy(o.quaternion)}}}}}class Te extends k{constructor(e){super(),this.controller=e,this.motionController=null,this.envMap=null,this.mesh=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}}class Se{constructor(){this.path=null}setPath(e){return this.path=e,this}createHandModel(e,t){const a=new Te(e);return e.addEventListener("connected",o=>{const s=o.data;s.hand&&!a.motionController&&(a.xrInputSource=s,t===void 0||t==="spheres"?a.motionController=new F(a,e,this.path,s.handedness,{primitive:"sphere"}):t==="boxes"?a.motionController=new F(a,e,this.path,s.handedness,{primitive:"box"}):t==="mesh"&&(a.motionController=new Ae(a,e,this.path,s.handedness))),e.visible=!0}),e.addEventListener("disconnected",()=>{e.visible=!1}),a}}let D=!1,f,b;const Pe=n=>{const e=new Se;f=n.xr.getHand(0),f.name="XR Hand Left",f.userData.index=0;const t=e.createHandModel(f,"mesh");t.name="XR Hand Model Left",f.add(t),b=n.xr.getHand(1),b.name="XR Hand Right",f.userData.index=1;const a=e.createHandModel(b,"mesh");a.name="XR Hand Model Right",b.add(a),D=!0},V=n=>(D||Pe(n),{hand0:f,hand1:b}),N=Ne();let R=!1,O=!1,z=!1,x,u,y,q,c;const Y={allowed:"Enter VR",not_allowed:"VR is not allowed",not_secure:"VR requires HTTPS",not_supported:"VR not supported"},Re=(n,e,t)=>{u=n,y=e,q=t,u.xr.enabled=!0},W=async()=>{if(navigator.xr===void 0)return"not_supported";if(!window.isSecureContext)return"not_secure";try{return await navigator.xr.isSessionSupported("immersive-vr")?"allowed":"not_supported"}catch{return"not_allowed"}},Oe=()=>N.fire("end"),Ie=()=>N.fire("exit"),J=async()=>{if(navigator.xr===void 0)throw new Error("navigator.xr is undefined!");x=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]}),x.addEventListener("end",Oe),x.addEventListener("exit",Ie),await u.xr.setSession(x),R=!0,N.fire("enter")},Le=()=>{R=!1,x==null||x.end()},je=async()=>{const n=await W(),e=document.createElement("button");return e.textContent=Y[n],n==="allowed"&&e.addEventListener("click",J),e},Q=n=>{O=n;const{grip0:e,grip1:t,controller0:a,controller1:o}=P(u);n?y.add(e,t,a,o):y.remove(e,t,a,o)},Fe=n=>{z=n;const{hand0:e,hand1:t}=V(u);n?y.add(e,t):y.remove(e,t)},He=(...n)=>{if(c===void 0){const{controller0:e,controller1:t}=P(u);c=ie(u,y,q,[e,t])}O||Q(!0),c.enable(...n)},Ue=()=>{c==null||c.disable()},_e=n=>{c==null||c.update(n)},p={get entered(){return R},get handsEnabled(){return z},get controllersEnabled(){return O},supportStateMessages:Y,setup:Re,createButton:je,requestSessionSupport:W,requestSession:J,endSession:Le,enableTeleport:He,disableTeleport:Ue,getControllers:()=>P(u),getControllerModels:()=>Me(u),getHands:()=>V(u),toggleControllers:Q,toggleHands:Fe,update:_e,...N},Xe=`import { trzy, xr } from 'trzy'

const { renderer, scene, camera, xr } = trzy()

xr.setup(renderer, scene, camera.current)

const button = await xr.createButton()
container.append(button)

xr.enableTeleport(floor)
`,$e={title:"XR",parameters:{docs:{description:{component:""},source:{code:Xe}}}},ke=()=>{var l;const n=document.createElement("div");n.style.cssText="width:100%;height:420px;";const{scene:e,camera:t,renderer:a}=re();n.append(a.domElement);const o=le(void 0,4,4);o.rotation.x=-Math.PI/2,e.add(o),de(),p.setup(a,e,t.current);const{model0:s,model1:i}=p.getControllerModels();return s.castShadow=!0,s.receiveShadow=!0,i.castShadow=!0,i.receiveShadow=!0,(l=e.getObjectByName("Strawberry"))==null||l.position.set(0,1,0),p.createButton().then(r=>{r.style.cssText=`
      position: absolute;
      bottom: 15px;
      left: 15px;
      z-index: 100;
    `,n.append(r),p.on("enter",()=>{p.toggleControllers(!0),p.toggleHands(!0),p.enableTeleport(o)}),he((h,m)=>p.update(m))}),n},w={render:ke};var H,U,_;w.parameters={...w.parameters,docs:{...(H=w.parameters)==null?void 0:H.docs,source:{originalSource:`{
  render
}`,...(_=(U=w.parameters)==null?void 0:U.docs)==null?void 0:_.source}}};const Ge=["Primary"];export{w as Primary,Ge as __namedExportsOrder,$e as default};
//# sourceMappingURL=index.stories-b2323653.js.map
